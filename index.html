<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Master Web Runner Pro</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0; background: #0f172a; color: #f8fafc;
            font-family: 'Consolas', monospace; display: flex; flex-direction: column; height: 100vh;
            overflow: hidden;
        }
        .header {
            padding: 12px; background: #1e293b; font-size: 13px;
            border-bottom: 2px solid #38bdf8; display: flex;
            justify-content: space-between; align-items: center;
        }
        #error-monitor {
            padding: 8px 15px; font-size: 12px; background: #1e293b;
            color: #10b981; border-bottom: 1px solid #334155; min-height: 32px;
        }
        #error-monitor.has-error { color: #ef4444; background: #450a0a; }

        .system-bar {
            display: flex; background: #1e293b; padding: 5px 10px; gap: 8px;
            border-bottom: 1px solid #334155;
        }
        .sys-btn {
            background: #475569; color: white; border: none; border-radius: 4px;
            padding: 6px 10px; font-size: 11px; cursor: pointer; flex: 1;
        }
        .sys-btn:active { background: #38bdf8; }

        .quick-keys {
            display: flex; background: #1e293b; padding: 5px; gap: 6px;
            border-bottom: 1px solid #334155; overflow-x: auto;
        }
        .key-btn {
            background: #334155; color: #38bdf8; border: 1px solid #475569;
            border-radius: 6px; padding: 10px 12px; font-size: 16px; font-weight: bold;
            white-space: nowrap; cursor: pointer; min-width: 45px;
        }
        .key-btn.attr { color: #facc15; font-size: 13px; }

        #code-editor {
            flex: 1; width: 100%; padding: 15px; background: #0f172a;
            color: #7dd3fc; border: none; outline: none; font-size: 16px;
            resize: none; line-height: 1.5; caret-color: #38bdf8;
        }
        .toolbar { padding: 10px; background: #1e293b; display: flex; gap: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        button.action { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; }
        .run-btn { background: #0ea5e9; }
        .clear-btn { background: #ef4444; }
    </style>
</head>
<body>

    <div class="header">
        <span>MASTER RUNNER PRO</span>
        <span id="save-status" style="color: #38bdf8;">v2.5 (PWA Ready)</span>
    </div>

    <div id="error-monitor">‚úì –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</div>

    <div class="system-bar">
        <button class="sys-btn" onclick="copyAll()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="sys-btn" onclick="pasteAll()">üì• –í—Å—Ç–∞–≤–∏—Ç—å</button>
        <button class="sys-btn" onclick="shareCode()">üì§ Share</button>
    </div>

    <div class="quick-keys">
        <button class="key-btn" onclick="quickInsert('<')">&lt;</button>
        <button class="key-btn" onclick="quickInsert('/')">/</button>
        <button class="key-btn" onclick="quickInsert('=')">=</button>
        <button class="key-btn" onclick="quickInsert('{')">{</button>
        <button class="key-btn" onclick="quickInsert('}')">}</button>
        <button class="key-btn attr" onclick="quickInsert('class=')">class</button>
        <button class="key-btn attr" onclick="quickInsert('style=')">style</button>
    </div>

    <textarea id="code-editor" spellcheck="false" placeholder="–ù–∞—á–Ω–∏ –ø–∏—Å–∞—Ç—å –∫–æ–¥..."></textarea>

    <div class="toolbar">
        <button class="action clear-btn" onclick="clearEditor()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="action run-btn" onclick="openCode()">–ó–ê–ü–£–°–¢–ò–¢–¨</button>
    </div>

    <script>
        const editor = document.getElementById('code-editor');
        const monitor = document.getElementById('error-monitor');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = () => {
            const savedCode = localStorage.getItem('master_runner_code');
            if (savedCode) {
                editor.value = savedCode;
                validateCode();
            }
        };

        function saveToStorage() {
            localStorage.setItem('master_runner_code', editor.value);
        }

        // –í—Å—Ç–∞–≤–∫–∞ –Ω–∞ –º–µ—Å—Ç–µ –∫—É—Ä—Å–æ—Ä–∞
        function insertAtCursor(text, moveCursor) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + moveCursor;
            validateCode();
            saveToStorage();
        }

        function quickInsert(input) {
            editor.focus();
            if (input.endsWith('=')) insertAtCursor(input + '""', input.length + 1);
            else if (input === '=') insertAtCursor('=""', 2);
            else if (input === '{') insertAtCursor('}', 0);
            else insertAtCursor(input, input.length);
        }

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Tab
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertAtCursor("  ", 2);
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫
        function validateCode() {
            const text = editor.value;
            let error = null;
            const tagStack = [];
            const voidTags = ['img', 'br', 'hr', 'input', 'meta', 'link'];
            const tagRegex = /<(\/)?([a-zA-Z1-6]+)/g;
            let match;

            while ((match = tagRegex.exec(text)) !== null) {
                const isClosing = match[1] === '/';
                const tagName = match[2].toLowerCase();
                if (voidTags.includes(tagName)) continue;
                if (isClosing) {
                    if (tagStack.length === 0 || tagStack[tagStack.length - 1] !== tagName) {
                        error = `–ù–µ–≤–µ—Ä–Ω—ã–π </${tagName}>`; break;
                    }
                    tagStack.pop();
                } else { tagStack.push(tagName); }
            }
            if (!error && tagStack.length > 0) error = `<${tagStack.pop()}> –Ω–µ –∑–∞–∫—Ä—ã—Ç`;

            if (error) {
                monitor.textContent = "‚ö† " + error;
                monitor.classList.add('has-error');
            } else {
                monitor.textContent = "‚úì –ö–æ–¥ –≤ –ø–æ—Ä—è–¥–∫–µ";
                monitor.classList.remove('has-error');
            }
        }

        editor.addEventListener('input', () => { validateCode(); saveToStorage(); });

        async function copyAll() {
            await navigator.clipboard.writeText(editor.value);
            alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
        }

        async function pasteAll() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) insertAtCursor(text, text.length);
            } catch (err) { alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –±—É—Ñ–µ—Ä—É"); }
        }

        function clearEditor() {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?")) {
                editor.value = '';
                localStorage.removeItem('master_runner_code');
                validateCode();
            }
        }

        function shareCode() {
            if (navigator.share) {
                navigator.share({ title: 'Master Code', text: editor.value });
            }
        }

        // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω "–î–æ–º–æ–π"
        function openCode() {
            let userCode = editor.value;
            
            // –ï—Å–ª–∏ –≤ –∫–æ–¥–µ –Ω–µ—Ç HEAD, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã PWA –Ω–∞ iOS
            if (!userCode.includes('<head>')) {
                userCode = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Master App</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: white; padding-top: env(safe-area-inset-top); }
        #back-btn { position: fixed; bottom: 20px; right: 20px; width: 44px; height: 44px; 
                   background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; 
                   font-size: 20px; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    ${userCode}
    <button id="back-btn" onclick="location.reload()">‚úï</button>
</body>
</html>`;
            }

            // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã Safari –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –∫–Ω–æ–ø–∫—É "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π"
            document.open();
            document.write(userCode);
            document.close();
        }
    </script>
</body>
</html>
